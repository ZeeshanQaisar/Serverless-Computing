metadata:
  name: dht11sensor
  labels:
    nuclio.io/project-name: d63a4015-261e-491c-b110-35f434cd5d32
spec:
  description: "Function the is called when a new message is arrived on the iot/sensors/temperature queue, //the function send back a feedback on the iot/logs queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-dht11sensor:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@192.168.43.152:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/mq2
  version: 1
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciB1cmwgPSByZXF1aXJlKCd1cmwnKTsKdmFyIGh0dHAgPSByZXF1aXJlKCdodHRwJyk7CgpsZXQgZXZlbnRfbmFtZTEgPSAic21va2VBbGVydCI7CmxldCBldmVudF9uYW1lMiA9ICJ1diI7CmxldCBhcGlfa2V5ID0gIm5IQzhRam9UdE5VN1VXY09ueUU2R0tWc0ctVFdFQ0V5Qkd5VW9SVU5UbFciOwpsZXQgd2FybmluZyA9IHRydWU7CgoKICAgICAgICBhc3luYyBmdW5jdGlvbiBsb2dnZXIobXNnKXsKICAgICAgICAgICAgdmFyIHEgPSAnaW90L3NlbnNvcnMvbXEyJzsKICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IGFtcXAuY29ubmVjdCgnYW1xcDovL2d1ZXN0Omd1ZXN0QDE5Mi4xNjguNDMuMTUyOjU2NzInKTsKICAgICAgICAgICAgY29uc3QgY2ggPSBhd2FpdCBjb25uZWN0aW9uLmNyZWF0ZUNoYW5uZWwoKTsKICAgICAgICAgICAgYXdhaXQgY2guYXNzZXJ0UXVldWUocSwge2R1cmFibGU6IGZhbHNlfSk7CiAgICAgICAgICAgIGNoLnNlbmRUb1F1ZXVlKHEsIEJ1ZmZlci5mcm9tKG1zZykpOwogICAgICAgICB9CgogICAgICAgICBsZXQgc2VuZElGVFRUID0gYXN5bmMgZnVuY3Rpb24oZXZlbnQsIGtleSwgdmFsdWUxLCB2YWx1ZTIsIHZhbHVlMyl7CiAgICAgICAgICAgIHZhciBwb3NfdXJsID0gYGh0dHBzOi8vbWFrZXIuaWZ0dHQuY29tL3RyaWdnZXIvc21va2VBbGVydC93aXRoL2tleS9uSEM4UWpvVHROVTdVV2NPbnlFNkdLVnNHLVRXRUNFeUJHeVVvUlVOVGxXYDsKICAgICAgICAgICAgbGV0IHBvc3REYXRhID0gSlNPTi5zdHJpbmdpZnkoeyB2YWx1ZTEsIHZhbHVlMiwgdmFsdWUzIH0pOwoKICAgICAgICAgICAgdmFyIHBhcnNlZFVybCA9IHVybC5wYXJzZShwb3NfdXJsKTsKICAgICAgICAgICAgdmFyIHBvc3Rfb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgIGhvc3RuYW1lOiBwYXJzZWRVcmwuaG9zdG5hbWUsCiAgICAgICAgICAgICAgICBwb3J0OiBwYXJzZWRVcmwucG9ydCwKICAgICAgICAgICAgICAgIHBhdGg6IHBhcnNlZFVybC5wYXRoLAogICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBwb3N0RGF0YS5sZW5ndGgKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsgCiAgICAgICAgICAgIHZhciBwb3N0X3JlcSA9IGh0dHAucmVxdWVzdChwb3N0X29wdGlvbnMsIGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICByZXMuc2V0RW5jb2RpbmcoJ3V0ZjgnKTsKICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgZnVuY3Rpb24gKGNodW5rKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUmVzcG9uc2U6ICcgKyBjaHVuayk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBUcmlnZ2VyIGEgUE9TVCB0byB0aGUgdXJsIHdpdGggdGhlIGJvZHkuCiAgICAgICAgcG9zdF9yZXEud3JpdGUocG9zdERhdGEpOwogICAgICAgIHBvc3RfcmVxLmVuZCgpOwogICAgfSAgIAoKICAgICAgICBleHBvcnRzLmhhbmRsZXIgPSBmdW5jdGlvbihjb250ZXh0LCBldmVudCkgewogICAgICAgICAgICB2YXIgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOwogICAgICAgICAgICB2YXIgX2RhdGEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLl9ldmVudC5ib2R5LmRhdGEpOwoKICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjaygiZmVlZGJhY2sgIitfZGF0YSk7CiAgICAgICAgICAgIGxvZ2dlcigiTVEyIGdhcyB2YWx1ZTogIitfZGF0YSk7CiAgICAgICAgICAgIC8vdmFyIHJheXMgID0gX2RhdGEuc2xpY2UoMCw2KTsKICAgICAgICAgICAgLy92YXIgcmF5cyA9IF9kYXRhCiAgICAgICAgICAgIC8vaWYoKHJheXM8PTYpKXsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbmRJRlRUVChldmVudF9uYW1lMSwgYXBpX2tleSwgInt3YXJuaW5nOnRydWUiLCJNUTIgZ2FzIHZhbHVlIitfZGF0YSk7CiAgICAgICAgICAgLy99CiAgICAgICAgICAgIAogICAgICAgIH07
    commands:
      - 'npm install amqplib'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
